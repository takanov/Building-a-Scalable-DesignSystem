name: ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†

# IssueãŒä½œæˆã•ã‚ŒãŸã¨ãã«ãƒˆãƒªã‚¬ãƒ¼
on:
  issues:
    types: [opened]

# æ¨©é™è¨­å®š
permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  # Phase 1: åŸºæœ¬çš„ãªè‡ªå‹•å¿œç­”
  auto-response:
    # regulation-requestãƒ©ãƒ™ãƒ«ãŒä»˜ã„ã¦ã„ã‚‹Issueã®ã¿å‡¦ç†
    if: contains(github.event.issue.labels.*.name, 'regulation-request')
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Issueä½œæˆè€…ã«è‡ªå‹•è¿”ä¿¡
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Issueã®æƒ…å ±ã‚’å–å¾—
            const issue = context.payload.issue;
            
            // è‡ªå‹•è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
            const message = `ğŸ‘‹ @${issue.user.login} ã•ã‚“ã€ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™!
            
            ## ğŸ¤– è‡ªå‹•å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™
            
            ä»¥ä¸‹ã®æ‰‹é †ã§é€²è¡Œã—ã¾ã™ï¼š
            
            1. âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã®ç¢ºèªï¼ˆå®Œäº†ï¼‰
            2. ğŸ”„ ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç”Ÿæˆï¼ˆæº–å‚™ä¸­ï¼‰
            3. ğŸ“ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ä½œæˆï¼ˆæº–å‚™ä¸­ï¼‰
            4. ğŸ‘€ ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡
            
            ---
            
            **ğŸ“‹ ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã‚µãƒãƒªãƒ¼:**
            - **ã‚¿ã‚¤ãƒˆãƒ«:** ${issue.title}
            - **ä½œæˆè€…:** @${issue.user.login}
            - **ä½œæˆæ—¥æ™‚:** ${new Date(issue.created_at).toLocaleString('ja-JP')}
            
            ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚å‡¦ç†ãŒå®Œäº†æ¬¡ç¬¬ã€ã“ã®Issueã«æ›´æ–°ã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚
            
            â€» Phase 1ã§ã¯è‡ªå‹•è¿”ä¿¡ã®ã¿å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚Phase 2ä»¥é™ã§å®Ÿéš›ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆã‚’å®Ÿè£…äºˆå®šã§ã™ã€‚`;
            
            // Issueã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: message
            });
            
            console.log('âœ… è‡ªå‹•è¿”ä¿¡ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');

      - name: Issueå‡¦ç†ä¸­ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['processing']
            });
            
            console.log('âœ… å‡¦ç†ä¸­ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ');

  # Phase 1: Issueã®å†…å®¹ã‚’è§£æã—ã¦æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
  parse-issue:
    if: contains(github.event.issue.labels.*.name, 'regulation-request')
    needs: auto-response
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Issueå†…å®¹ã®è§£æ
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const body = issue.body;
            
            // Issueãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
            // Phase 2ä»¥é™ã§ã€ã‚ˆã‚Šé«˜åº¦ãªè§£æã‚’å®Ÿè£…äºˆå®š
            
            console.log('ğŸ“Š Issueæƒ…å ±:');
            console.log(`- ã‚¿ã‚¤ãƒˆãƒ«: ${issue.title}`);
            console.log(`- æœ¬æ–‡é•·: ${body.length}æ–‡å­—`);
            console.log(`- ãƒ©ãƒ™ãƒ«: ${issue.labels.map(l => l.name).join(', ')}`);
            
            // Phase 2ã§ã“ã“ã«Notioné€£æºã‚„Claude Codeå‘¼ã³å‡ºã—ã‚’è¿½åŠ äºˆå®š
            
            // è§£æå®Œäº†ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
            const analysisComment = `## ğŸ“Š è§£æå®Œäº†
            
            Issueå†…å®¹ã®è§£æãŒå®Œäº†ã—ã¾ã—ãŸã€‚
            
            **æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆPhase 2ä»¥é™ã§å®Ÿè£…äºˆå®šï¼‰:**
            - ãƒ¬ã‚®ãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®é©ç”¨
            - æ—¢å­˜ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
            - Claude Codeã«ã‚ˆã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ
            - PRã®è‡ªå‹•ä½œæˆ
            
            ç¾åœ¨ã¯Phase 1ã®ãŸã‚ã€ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†ã—ã¾ã™ã€‚`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: analysisComment
            });
